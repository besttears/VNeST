<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ุชูุฑูู VNeST โ ุฌูุณุฉ ุงููุฑุงุฌุน</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='playground.css') }}">
</head>
<body>
<div class="container" role="main">
  <h1>ุชูุฑูู VNeST</h1>
  <p class="note">ูุธูุฑ ุชูุฑูู ูุงุญุฏ ูู ูู ุดุงุดุฉ. ููููู ุงูุถุบุท ุนูู ๐ ููุฑุงุกุฉ ุงูุณุคุงูุ ุฃู ๐ค ููุฅุฌุงุจุฉ ุตูุชูุงู.</p>

  <!-- Progress -->
  <div class="progress-wrap" aria-label="ุดุฑูุท ุงูุชูุฏู">
    <div class="progress-label">
      <span id="progText">ุงูุฎุทูุฉ 1 ูู 6</span>
      <span id="progName">ุงุฎุชูุงุฑ ุงููุงุนู</span>
    </div>
    <div class="progress" aria-hidden="true"><div id="progBar" class="progress-bar"></div></div>
  </div>
</div>

<div class="container">
  <!-- A -->
  <section id="view-A" class="view active" data-step-name="ุงุฎุชูุงุฑ ุงููุงุนู" aria-live="polite">
    <h2 id="aHeading">ูก) ูู ุงูุฐู ููููู ุงูููุงู ุจุงููุนูุ</h2>
    <p id="aPrompt"></p>
    <div class="assist">
      <button class="icon small" id="aSpeak" aria-label="ูุฑุงุกุฉ ุงูุณุคุงู">๐ <span>ุงุณุชูุน</span></button>
      <button class="icon small mic" id="aMic" aria-label="ุงูุชุญุฏุซ ููุฅุฌุงุจุฉ">๐ค <span>ุชุญุฏุซ</span></button>
      <span class="hint">ุงูุชุจ ุฃู ุชุญุฏุซ ููุฅุฌุงุจุฉ.</span>
    </div>
    <input id="aInput" aria-labelledby="aHeading aPrompt" placeholder="ุงูุชุจ ุฅุฌุงุจุฉ">
    <div class="navbar">
      <button id="aNext">ุงูุชุงูู</button>
    </div>
  </section>

  <!-- B -->
  <section id="view-B" class="view" data-step-name="ุงูููุนูู ุจู" aria-live="polite">
    <h2 id="bHeading">ูข) ูุง ุงูุดูุก ุงููุฑุชุจุท ุจุงููุนูุ</h2>
    <p id="bPrompt"></p>
    <div class="assist">
      <button class="icon small" id="bSpeak">๐ <span>ุงุณุชูุน</span></button>
      <button class="icon small mic" id="bMic">๐ค <span>ุชุญุฏุซ</span></button>
      <span class="hint">ุงูุชุจ ุฃู ุชุญุฏุซ ููุฅุฌุงุจุฉ.</span>
    </div>
    <input id="bInput" aria-labelledby="bHeading bPrompt" placeholder="ุงูุชุจ ุฅุฌุงุจุฉ">
    <div class="navbar">
      <button id="bNext">ุงูุชุงูู</button>
    </div>
  </section>

  <!-- C -->
  <section id="view-C" class="view" data-step-name="ููุงู ุงูุญุฏุซ" aria-live="polite">
    <h2 id="cHeading">ูฃ) ุฃูู ูุฏ ูุญุฏุซ ุงููุนูุ</h2>
    <p id="cPrompt"></p>
    <div class="assist">
      <button class="icon small" id="cSpeak">๐ <span>ุงุณุชูุน</span></button>
      <button class="icon small mic" id="cMic">๐ค <span>ุชุญุฏุซ</span></button>
      <span class="hint">ุงูุชุจ ุฃู ุชุญุฏุซ ููุฅุฌุงุจุฉ.</span>
    </div>
    <input id="cInput" aria-labelledby="cHeading cPrompt" placeholder="ุงูุชุจ ุฅุฌุงุจุฉ">
    <div class="navbar">
      <button id="cNext">ุงูุชุงูู</button>
    </div>
  </section>

  <!-- D -->
  <section id="view-D" class="view" data-step-name="ุชุฑููุจ ุงูุฌูู" aria-live="polite">
    <h2>ูค) ูููู ุฌููุชูู ุตุญูุญุชูู</h2>
    <p class="note">ุงุณุญุจ ุงููููุงุช ูุถุนูุง ูู ุงูููุงู ุงูุตุญูุญ.</p>
    <div class="canvas" id="canvas" aria-label="ููุญุฉ ุชุฑุชูุจ ุงููููุงุช"></div>
    <div class="stack">
      <div>ุฌููุฉ 1: <span class="sentence-blank" id="s1-subj">ูุงุนู</span>
        <span class="sentence-blank" id="s1-verb"></span>
        <span class="sentence-blank" id="s1-obj">ููุนูู</span>
        <span class="sentence-blank" id="s1-place">ููุงู</span>
      </div>
      <div>ุฌููุฉ 2: <span class="sentence-blank" id="s2-subj">ูุงุนู</span>
        <span class="sentence-blank" id="s2-verb"></span>
        <span class="sentence-blank" id="s2-obj">ููุนูู</span>
        <span class="sentence-blank" id="s2-place">ููุงู</span>
      </div>
    </div>
    <div class="navbar">
      <button id="dNext">ุงูุชุงูู</button>
    </div>
  </section>

  <!-- E -->
  <section id="view-E" class="view" data-step-name="ูุญุต ูุญูู" aria-live="polite">
    <h2 id="eHeading">ูฅ) ูู ูุฐู ุงูุฌูู ุณูููุฉุ</h2>
    <p id="eSentence"></p>
    <div class="assist">
      <button class="icon small" id="eSpeak">๐ <span>ุงุณุชูุน</span></button>
      <button class="icon small mic" id="eMicYes">๐ค <span>ูู: ูุนู</span></button>
      <button class="icon small mic" id="eMicNo">๐ค <span>ูู: ูุง</span></button>
      <span class="hint">ููููู ููู ูุนู/ูุง ุตูุชูุงู.</span>
    </div>
    <div class="row">
      <button id="eYes">ูุนู</button>
      <button id="eNo" class="secondary">ูุง</button>
    </div>
    <div id="eCorrectionBlock" class="stack" style="display:none">
      <label for="eCorrection" class="note">ุตุญูุญ ุงูุฌููุฉ:</label>
      <div class="assist">
        <button class="icon small mic" id="eMicFix">๐ค <span>ุชุญุฏุซ</span></button>
      </div>
      <input id="eCorrection" placeholder="ุงูุชุจ ุงูุชุตุญูุญ ุฃู ุงุณุชุฎุฏู ุงูุฅููุงุก ุงูุตูุชู">
      <button id="eConfirm">ุชุฃููุฏ</button>
    </div>
  </section>

  <!-- F -->
  <section id="view-F" class="view" data-step-name="ูุญุต ุฏูุงูู" aria-live="polite">
    <h2 id="fHeading">ูฆ) ูุญุต ุฏูุงูู</h2>
    <p id="fPrompt"></p>
    <div class="assist">
      <button class="icon small" id="fSpeak">๐ <span>ุงุณุชูุน</span></button>
      <button class="icon small mic" id="fMic">๐ค <span>ุชุญุฏุซ</span></button>
      <span class="hint">ุงูุชุจ ูุนู/ูุง ูุณุจุจูุ ุฃู ุตูุญูุญ ุงูุนุจุงุฑุฉ.</span>
    </div>
    <input id="fInput" aria-labelledby="fHeading fPrompt" placeholder="ุงูุชุจ ุฃู ุชุญุฏุซ ูุฅุฏุฎุงู ุงูุฅุฌุงุจุฉ">
    <div class="navbar">
      <button id="fNext">ุฅุฑุณุงู</button>
    </div>
  </section>

  <section id="view-Done" class="view" data-step-name="ุงูุชูู">
    <h2>ุฃุญุณูุช!</h2>
    <p>ุงูุชูุช ุงููููุฉ. ููููู ุฅุบูุงู ุงูุตูุญุฉ ุงูุขู.</p>
  </section>
</div>

<script>
  /* --------------- TTS & ASR helpers --------------- */
  function speak(text){
    try{
      if (!('speechSynthesis' in window)) return alert('ุงููุชุตูุญ ูุง ูุฏุนู ูุฑุงุกุฉ ุงููุต.');
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      const pickVoice = () => {
        const voices = speechSynthesis.getVoices();
        const ar = voices.find(v => /ar|Arabic/i.test(v.lang||v.name));
        if (ar) u.voice = ar; else if (voices[0]) u.voice = voices[0];
        speechSynthesis.speak(u);
      };
      if (speechSynthesis.getVoices().length) pickVoice();
      else speechSynthesis.onvoiceschanged = pickVoice;
    }catch(e){}
  }
  function makeRecognizer(onResult){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) return null;
    const r = new SR();
    r.lang = 'ar-SA';
    r.interimResults = false; r.maxAlternatives = 1;
    r.onresult = (e)=> { const txt = e.results[0][0].transcript || ''; onResult(txt); };
    r.onerror = ()=>{};
    return r;
  }

  // Progress
  const TOTAL_STEPS = 6;
  const progBar  = document.getElementById('progBar');
  const progText = document.getElementById('progText');
  const progName = document.getElementById('progName');
  function showView(id, stepNum){
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
    const el = document.getElementById(id);
    if (el){ el.classList.add('active'); window.scrollTo({top:0, behavior:'instant'}); }
    if (stepNum){ setProgress(stepNum, el?.dataset.stepName || ''); }
  }
  function setProgress(n, label){
    const pct = Math.max(0, Math.min(100, (n / TOTAL_STEPS) * 100));
    progBar.style.width = pct + '%';
    progText.textContent = `ุงูุฎุทูุฉ ${n} ูู ${TOTAL_STEPS}`;
    progName.textContent = label || '';
  }
  setProgress(1, document.getElementById('view-A').dataset.stepName);

  // Payload
  let payload;
  try {
    payload = JSON.parse('{{ payload_json|escapejs }}');
  } catch(e) {
    // Fallback when template isn't rendered yet or JSON is invalid
    payload = {};
  }
  const verb = payload.verb;
  const subjects = payload.subjects || [];
  const objects  = payload.objects  || [];
  const places   = payload.places   || [];
  const grammarItems = (payload.grammar_questions || []).map(g=>g.sentence).filter(Boolean);
  const semanticItems = (payload.semantic_items || []).map(s=>s.item).filter(Boolean);

  // A
  let aIndex=0; const aAnswers=[];
  const aPrompt = document.getElementById('aPrompt');
  const aInput  = document.getElementById('aInput');
  function updateASubject(){ aPrompt.textContent = `ููู ุงููู ูููู ${verb}ุ (ุฅุฌุงุจุฉ ${aIndex+1})`; }
  updateASubject();
  document.getElementById('aSpeak').onclick = ()=> speak(aPrompt.textContent);
  const aRec = makeRecognizer(txt => { aInput.value = txt; });
  document.getElementById('aMic').onclick = ()=> aRec ? aRec.start() : alert('ูุง ูุฏุนู ุงููุชุตูุญ ุงูุฅููุงุก ุงูุตูุชู.');
  document.getElementById('aNext').onclick = ()=>{
    aAnswers.push(aInput.value.trim());
    aInput.value='';
    aIndex++;
    if (aIndex<2){ updateASubject(); }
    else { prepareB(); showView('view-B', 2); }
  };

  // B
  let bIndex=0; const bAnswers=[];
  const bPrompt = document.getElementById('bPrompt');
  const bInput  = document.getElementById('bInput');
  function updateBPrompt(){ bPrompt.textContent = `ุฅูุด ${(subjects[bIndex]||'ููู')} ${verb}ุ`; }
  function prepareB(){ bIndex=0; updateBPrompt(); }
  document.getElementById('bSpeak').onclick = ()=> speak(bPrompt.textContent);
  const bRec = makeRecognizer(txt => { bInput.value = txt; });
  document.getElementById('bMic').onclick = ()=> bRec ? bRec.start() : alert('ูุง ูุฏุนู ุงููุชุตูุญ ุงูุฅููุงุก ุงูุตูุชู.');
  document.getElementById('bNext').onclick = ()=>{
    bAnswers.push(bInput.value.trim());
    bInput.value=''; bIndex++;
    if (bIndex<2){ updateBPrompt(); }
    else { prepareC(); showView('view-C', 3); }
  };

  // C
  let cIndex=0; const cAnswers=[];
  const cPrompt = document.getElementById('cPrompt');
  const cInput  = document.getElementById('cInput');
  function updateCPrompt(){ cPrompt.textContent = `ููู ${(subjects[cIndex]||'ููู')} ูููู ${verb}ุ`; }
  function prepareC(){ cIndex=0; updateCPrompt(); }
  document.getElementById('cSpeak').onclick = ()=> speak(cPrompt.textContent);
  const cRec = makeRecognizer(txt => { cInput.value = txt; });
  document.getElementById('cMic').onclick = ()=> cRec ? cRec.start() : alert('ูุง ูุฏุนู ุงููุชุตูุญ ุงูุฅููุงุก ุงูุตูุชู.');
  document.getElementById('cNext').onclick = ()=>{
    cAnswers.push(cInput.value.trim());
    cInput.value=''; cIndex++;
    if (cIndex<2){ updateCPrompt(); }
    else { initCanvas(); showView('view-D', 4); }
  };

  // D
  function initCanvas(){
    const canvas = document.getElementById('canvas');
    canvas.innerHTML = '';
    const words = [verb, ...subjects, ...objects, ...places].filter(Boolean);
    words.forEach(w=>{
      const el = document.createElement('div');
      el.className='word'; el.textContent=w;
      el.style.top = (10+Math.random()*260)+'px';
      el.style.left = (10+Math.random()*620)+'px';
      el.setAttribute('role','button'); el.setAttribute('tabindex','0');
      el.setAttribute('aria-label', `ูููุฉ: ${w}`);
      canvas.appendChild(el);
      makeDraggable(el);
    });
    document.getElementById('s1-verb').textContent = verb;
    document.getElementById('s2-verb').textContent = verb;
    ['s1-subj','s1-obj','s1-place','s2-subj','s2-obj','s2-place'].forEach(id=>{
      const el = document.getElementById(id);
      el.textContent = el.id.includes('subj') ? 'ูุงุนู' : (el.id.includes('obj') ? 'ููุนูู' : 'ููุงู');
      el.ondragover = e => e.preventDefault();
    });
  }
  function makeDraggable(el){
    el.draggable=true;
    el.ondragstart = e=> e.dataTransfer.setData('text/plain', el.textContent);
    document.addEventListener('dragover', e=>e.preventDefault());
    document.addEventListener('drop', e=>{
      if (e.target.classList.contains('sentence-blank')){
        e.preventDefault();
        e.target.textContent = e.dataTransfer.getData('text/plain');
      }
    });
  }
  document.getElementById('dNext').onclick = ()=>{
    startGrammar(); showView('view-E', 5);
  };

  // E
  let eIndex=0;
  const eSentence = document.getElementById('eSentence');
  const eBlock = document.getElementById('eCorrectionBlock');
  const eCorrection = document.getElementById('eCorrection');
  function startGrammar(){
    eIndex=0; eBlock.style.display='none'; eCorrection.value='';
    eSentence.textContent = grammarItems[eIndex] || `ุงููุทุฉ ${verb} ุงูุญููุจ.`;
  }
  document.getElementById('eSpeak').onclick = ()=> speak(eSentence.textContent);
  const eYesRec = makeRecognizer(txt => { if (/^\s*ูุนู\s*$/i.test(txt)) document.getElementById('eYes').click(); });
  const eNoRec  = makeRecognizer(txt => { if (/^\s*ูุง\s*$/i.test(txt))  document.getElementById('eNo').click();  });
  document.getElementById('eMicYes').onclick = ()=> eYesRec ? eYesRec.start() : alert('ูุง ูุฏุนู ุงููุชุตูุญ ุงูุฅููุงุก ุงูุตูุชู.');
  document.getElementById('eMicNo').onclick  = ()=> eNoRec  ? eNoRec.start()  : alert('ูุง ูุฏุนู ุงููุชุตูุญ ุงูุฅููุงุก ุงูุตูุชู.');
  document.getElementById('eYes').onclick = ()=> nextGrammar();
  document.getElementById('eNo').onclick  = ()=> { eBlock.style.display='block'; };
  const eFixRec = makeRecognizer(txt => { eCorrection.value = txt; });
  document.getElementById('eMicFix').onclick = ()=> eFixRec ? eFixRec.start() : alert('ูุง ูุฏุนู ุงููุชุตูุญ ุงูุฅููุงุก ุงูุตูุชู.');
  document.getElementById('eConfirm').onclick = ()=>{
    eBlock.style.display='none'; eCorrection.value=''; nextGrammar();
  };
  function nextGrammar(){
    eIndex++;
    if (eIndex < Math.max(3, grammarItems.length)){
      eSentence.textContent = grammarItems[eIndex] || `ุฃูุง ${verb} ุงูุชูุงุญุฉ ูู ุงููุทุจุฎ.`;
    } else {
      startSemantics(); showView('view-F', 6);
    }
  }

  // F
  let fIndex=0;
  const fPrompt = document.getElementById('fPrompt');
  const fInput  = document.getElementById('fInput');
  function startSemantics(){ fIndex=0; fPrompt.textContent = semanticItems[fIndex] || `${verb} ุงูููู ุงูุดุงู`; fInput.value=''; }
  document.getElementById('fSpeak').onclick = ()=> speak(fPrompt.textContent);
  const fRec = makeRecognizer(txt => { fInput.value = txt; });
  document.getElementById('fMic').onclick = ()=> fRec ? fRec.start() : alert('ูุง ูุฏุนู ุงููุชุตูุญ ุงูุฅููุงุก ุงูุตูุชู.');
  document.getElementById('fNext').onclick = ()=>{
    fIndex++; fInput.value='';
    if (fIndex < Math.max(3, semanticItems.length)){
      fPrompt.textContent = semanticItems[fIndex] || `${verb} ุงูุณูุงุฑุฉ ุงููููุฉ`;
    } else {
      showView('view-Done'); // 6/6 complete
    }
  };
</script>
</body>
</html>
