<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ูุนุงููุฉ VNeST โ ูููSLP</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='playground.css') }}">
</head>
<body>
  <div class="container" role="main">
    <h1>VNeST โ ูุนุงููุฉ ุงูุฃุฎุตุงุฆู/ูุฉ</h1>
    <p class="note" id="note">ุงููุนู ุงูุญุงูู: <strong id="verb">{{ verb }}</strong>. ุชูุฑูู ูุงุญุฏ ูู ูู ุดุงุดุฉ. ููููู ุชุดุบูู ูุฑุงุกุฉ ุงููุต ุฃู ุงุณุชุฎุฏุงู ุงูุฅููุงุก ุงูุตูุชู.</p>
</div>
    <!-- Progress -->
    <div class="progress-wrap" aria-label="ุดุฑูุท ุงูุชูุฏู">
      <div class="progress-label">
        <span id="progText">ุงูุฎุทูุฉ 1 ูู 6</span>
        <span id="progName">ุงุฎุชูุงุฑ ุงููุงุนู</span>
      </div>
      <div class="progress" aria-hidden="true"><div id="progBar" class="progress-bar"></div></div>
    </div>

    <!-- A: SUBJECTS (asked twice) -->
    <section id="view-A" class="view active" data-step-name="ุงุฎุชูุงุฑ ุงููุงุนู" aria-live="polite">
      <h2 id="aHeading">A </h2>
      <p id="aPrompt">ููู ุงููู ูููู ูุณูู ูุฐุงุงููุนูุ.({{ verb }})</p>

      <div class="assist" aria-label="ูุณุงุนุฏุฉ ุงููุตูู">
        <button class="icon small" id="aSpeak" aria-label="ูุฑุงุกุฉ ุงูุณุคุงู ุจุตูุช ุนุงูู"><span>๐</span></button>
        <button class="icon small mic" id="aMic" aria-label="ุงูุชุญุฏุซ ููุฅุฌุงุจุฉ"><span>๐ค</span></button>
        <span class="hint" id="aHint">ููููู ุงููุชุงุจุฉ ุฃู ุงูุถุบุท ุนูู โุชุญุฏุซโ.</span>
      </div>

      <input id="aInput" aria-labelledby="aHeading aPrompt" >
      <div class="navbar">
        <button id="aNext" aria-label="ุงูุชุงูู ุฅูู ุงูุฎุทูุฉ ุงูุชุงููุฉ">ุงูุชุงูู</button>
      </div>
      <!-- TODO(Azure): generate subject prompts -->
    </section>

    <!-- B: OBJECT for each subject -->
    <section id="view-B" class="view" data-step-name="ุงูููุนูู ุจู" aria-live="polite">
      <h2 id="bHeading">ุงูุฎุทูุฉ B โ ุงุฎุชูุงุฑ ุงูููุนูู ุจู</h2>
      <p id="bPrompt"></p>

      <div class="assist">
        <button class="icon small" id="bSpeak" aria-label="ูุฑุงุกุฉ ุงูุณุคุงู ุจุตูุช ุนุงูู">๐ <span>ุงุณุชูุน</span></button>
        <button class="icon small mic" id="bMic" aria-label="ุงูุชุญุฏุซ ููุฅุฌุงุจุฉ">๐ค <span>ุชุญุฏุซ</span></button>
        <span class="hint">ููููู ุงููุชุงุจุฉ ุฃู ุงูุฅููุงุก ุงูุตูุชู.</span>
      </div>

      <input id="bInput" aria-labelledby="bHeading bPrompt" placeholder="ุงูุชุจ ุฅุฌุงุจุฉ ุฃู ุงุณุชุฎุฏู (ุชุญุฏุซ)">
      <div class="navbar">
        <button id="bNext">ุงูุชุงูู</button>
      </div>
      <!-- TODO(Azure): score object answers -->
    </section>

    <!-- C: PLACE for each subject -->
    <section id="view-C" class="view" data-step-name="ููุงู ุงูุญุฏุซ" aria-live="polite">
      <h2 id="cHeading">ุงูุฎุทูุฉ C โ ุฃูู ูุฏ ูุญุฏุซ ุงููุนูุ</h2>
      <p id="cPrompt"></p>

      <div class="assist">
        <button class="icon small" id="cSpeak" aria-label="ูุฑุงุกุฉ ุงูุณุคุงู ุจุตูุช ุนุงูู">๐ <span>ุงุณุชูุน</span></button>
        <button class="icon small mic" id="cMic" aria-label="ุงูุชุญุฏุซ ููุฅุฌุงุจุฉ">๐ค <span>ุชุญุฏุซ</span></button>
        <span class="hint">ุงูุชุจ ุฃู ุชุญุฏุซ ููุฅุฌุงุจุฉ.</span>
      </div>

      <input id="cInput" aria-labelledby="cHeading cPrompt" placeholder="ุงูุชุจ ุฅุฌุงุจุฉ ุฃู ุงุณุชุฎุฏู (ุชุญุฏุซ)">
      <div class="navbar">
        <button id="cNext">ุงูุชุงูู</button>
      </div>
      <!-- TODO(Azure): speech + score -->
    </section>

    <!-- D: CANVAS (drag and drop) -->
    <section id="view-D" class="view" data-step-name="ุชุฑููุจ ุงูุฌูู">
      <h2>D โ ุชุฑููุจ ุงูุฌูู ุจุงูุณุญุจ ูุงูุฅููุงุช</h2>
      <p class="note">ุงุณุญุจ ุงููููุงุช ูุถุนูุง ูู ุงููุฑุงุบ ุงูููุงุณุจ  </p><br></br><p( ----/ ---- / ------).></p>
      <div class="canvas" id="canvas" aria-label="ููุญุฉ ุชุฑุชูุจ ุงููููุงุช"></div>
      <div class="stack" aria-label="ูููุฐุฌุง ุงูุฌูู">
        <div>ุฌููุฉ 1:
          <span class="sentence-blank" id="s1-subj" aria-label="ูุงุนู ุงูุฌููุฉ ุงูุฃููู">ูุงุนู</span>
          <span class="sentence-blank" id="s1-verb" aria-label="ูุนู ุงูุฌููุฉ ุงูุฃููู">{{ verb }}</span>
          <span class="sentence-blank" id="s1-obj" aria-label="ููุนูู ุงูุฌููุฉ ุงูุฃููู">ููุนูู</span>
          <span class="sentence-blank" id="s1-place" aria-label="ููุงู ุงูุฌููุฉ ุงูุฃููู">ููุงู</span>
        </div>
        <div>ุฌููุฉ 2:
          <span class="sentence-blank" id="s2-subj" aria-label="ูุงุนู ุงูุฌููุฉ ุงูุซุงููุฉ">ูุงุนู</span>
          <span class="sentence-blank" id="s2-verb" aria-label="ูุนู ุงูุฌููุฉ ุงูุซุงููุฉ">{{ verb }}</span>
          <span class="sentence-blank" id="s2-obj" aria-label="ููุนูู ุงูุฌููุฉ ุงูุซุงููุฉ">ููุนูู</span>
          <span class="sentence-blank" id="s2-place" aria-label="ููุงู ุงูุฌููุฉ ุงูุซุงููุฉ">ููุงู</span>
        </div>
      </div>
      <div class="navbar">
        <button id="dNext">ุงูุชุงูู</button>
      </div>
      <!-- TODO(Azure): classify correctness -->
    </section>

    <!-- E: GRAMMAR -->
    <section id="view-E" class="view" data-step-name="ูุญุต ูุญูู" aria-live="polite">
      <h2 id="eHeading">ุงูุฎุทูุฉ E โ ูุญุต ูุญูู (ูฃ ุฌูู)</h2>
      <p id="eSentence" aria-live="assertive"></p>

      <div class="assist">
        <button class="icon small" id="eSpeak" aria-label="ูุฑุงุกุฉ ุงูุฌููุฉ ุจุตูุช ุนุงูู">๐ <span>ุงุณุชูุน</span></button>
        <button class="icon small mic" id="eMicYes" aria-label="ูู ูุนู">๐ค <span>ูู: ูุนู</span></button>
        <button class="icon small mic" id="eMicNo" aria-label="ูู ูุง">๐ค <span>ูู: ูุง</span></button>
        <span class="hint">ููููู ุงูุถุบุท ุนูู ูุนู/ูุง ุฃู ููููุง ุตูุชูุงู.</span>
      </div>

      <div class="row">
        <button id="eYes">ูุนู</button>
        <button id="eNo" class="secondary">ูุง</button>
      </div>

      <div id="eCorrectionBlock" class="stack" style="display:none">
        <label for="eCorrection" class="note">ุงูุชุฑุญ ุงูุชุตุญูุญ:</label>
        <div class="assist">
          <button class="icon small mic" id="eMicFix" aria-label="ุชุญุฏุซ ูุงูุชุฑุงุญ ุงูุชุตุญูุญ">๐ค <span>ุชุญุฏุซ</span></button>
        </div>
        <input id="eCorrection" placeholder="ุงูุชุจ ุฃู ุงุณุชุฎุฏู ุงูุฅููุงุก ุงูุตูุชู">
        <button id="eConfirm">ุชุฃููุฏ</button>
      </div>
    </section>

    <!-- F: SEMANTICS -->
    <section id="view-F" class="view" data-step-name="ูุญุต ุฏูุงูู" aria-live="polite">
      <h2 id="fHeading">ุงูุฎุทูุฉ F โ ูุญุต ุฏูุงูู</h2>
      <p id="fPrompt"></p>

      <div class="assist">
        <button class="icon small" id="fSpeak" aria-label="ูุฑุงุกุฉ ุงูุนูุตุฑ ุจุตูุช ุนุงูู">๐ <span>ุงุณุชูุน</span></button>
        <button class="icon small mic" id="fMic" aria-label="ุชุญุฏุซ ููุฅุฌุงุจุฉ">๐ค <span>ุชุญุฏุซ</span></button>
        <span class="hint">ุงูุชุจ ูุนู/ูุง ูุณุจุจูุ ุฃู ุตูุญูุญ ุงูุนุจุงุฑุฉ.</span>
      </div>

      <input id="fInput" aria-labelledby="fHeading fPrompt" placeholder="ุฃุฏุฎู ุฌูุงุจู (ูุต ุฃู ุตูุช)">
      <div class="navbar">
        <button id="fNext">ุงูุชุงูู</button>
      </div>
    </section>

    <!-- SHARE -->
    <section id="view-Share" class="view" data-step-name="ูุดุงุฑูุฉ ุงูููุนุจ">
      <h2>ุงูุชูุช ุงููุนุงููุฉ</h2>
      <p>ุงูุณุฎ ุฑุงุจุท ุงูููุนุจ ูุงูุดุฑู ูููุฑุงุฌุน.</p>
      <button id="shareBtn">ุดุงุฑู ุงูููุนุจ</button>
      <div id="shareResult" class="stack" style="display:none"></div>
    </section>
  </div>

<script>
  /* ------------------ Accessibility helpers: TTS & ASR ------------------ */
  // Text-to-Speech (Arabic preferred)
  function speak(text){
    try{
      if (!('speechSynthesis' in window)) return alert('ุงููุชุตูุญ ูุง ูุฏุนู ูุฑุงุกุฉ ุงููุต.');
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      const pickVoice = () => {
        const voices = speechSynthesis.getVoices();
        const ar = voices.find(v => /ar|Arabic/i.test(v.lang||v.name));
        if (ar) u.voice = ar; else if (voices[0]) u.voice = voices[0];
        speechSynthesis.speak(u);
      };
      if (speechSynthesis.getVoices().length) pickVoice();
      else speechSynthesis.onvoiceschanged = pickVoice;
    }catch(e){}
  }

  // Automatic Speech Recognition (Web Speech API)
  function makeRecognizer(onResult){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) return null;
    const r = new SR();
    r.lang = 'ar-SA';
    r.interimResults = false;
    r.maxAlternatives = 1;
    r.onresult = (e)=> {
      const txt = e.results[0][0].transcript || '';
      onResult(txt);
    };
    r.onerror = ()=>{};
    return r;
  }

  // Progress
  const TOTAL_STEPS = 6;
  const progBar  = document.getElementById('progBar');
  const progText = document.getElementById('progText');
  const progName = document.getElementById('progName');
  function showView(id, stepNum){
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
    const el = document.getElementById(id);
    if (el){ el.classList.add('active'); window.scrollTo({top:0, behavior:'instant'}); }
    if (stepNum){ setProgress(stepNum, el?.dataset.stepName || ''); }
  }
  function setProgress(n, label){
    const pct = Math.max(0, Math.min(100, (n / TOTAL_STEPS) * 100));
    progBar.style.width = pct + '%';
    progText.textContent = `ุงูุฎุทูุฉ ${n} ูู ${TOTAL_STEPS}`;
    progName.textContent = label || '';
  }
  setProgress(1, document.getElementById('view-A').dataset.stepName);

  // Data
  const verb = document.getElementById('verb').textContent;
  const subjects = [];
  const objects = [];
  const places  = [];

  /* ------------------ STEP A ------------------ */
  let aCount = 0;
  const aInput  = document.getElementById('aInput');
  const aPrompt = document.getElementById('aPrompt');
  document.getElementById('aSpeak').onclick = ()=> speak(aPrompt.textContent);
  const aRec = makeRecognizer(txt => { aInput.value = txt; });
  document.getElementById('aMic').onclick = ()=> aRec ? aRec.start() : alert('ุงููุชุตูุญ ูุง ูุฏุนู ุงูุฅููุงุก ุงูุตูุชู.');
  document.getElementById('aNext').onclick = ()=>{
    const val = aInput.value.trim();
    if (val) subjects.push(val);
    aInput.value='';
    aCount++;
    if (aCount < 2){
      aPrompt.textContent = `(${verb}) .....ููู ุงููู ูููู ูุณูู ูุฐุง ุงููุนู ุฉ ${aCount+1})`;
    } else {
      prepareB();
      showView('view-B', 2);
    }
  };

  /* ------------------ STEP B ------------------ */
  let bIndex = 0;
  const bInput = document.getElementById('bInput');
  const bPrompt = document.getElementById('bPrompt');
  function updateBPrompt(){ const s = subjects[bIndex] || 'ููู'; bPrompt.textContent = `ุฅูุด ${s} ${verb}ุ`; }
  function prepareB(){ bIndex=0; updateBPrompt(); }
  document.getElementById('bSpeak').onclick = ()=> speak(bPrompt.textContent);
  const bRec = makeRecognizer(txt => { bInput.value = txt; });
  document.getElementById('bMic').onclick = ()=> bRec ? bRec.start() : alert('ุงููุชุตูุญ ูุง ูุฏุนู ุงูุฅููุงุก ุงูุตูุชู.');
  document.getElementById('bNext').onclick = ()=>{
    const val = bInput.value.trim(); objects[bIndex] = val || '';
    bInput.value=''; bIndex++;
    if (bIndex < 2){ updateBPrompt(); }
    else { prepareC(); showView('view-C', 3); }
  };

  /* ------------------ STEP C ------------------ */
  let cIndex = 0;
  const cInput = document.getElementById('cInput');
  const cPrompt = document.getElementById('cPrompt');
  function updateCPrompt(){ const s = subjects[cIndex] || 'ููู'; cPrompt.textContent = `ููู ${s} ูููู ${verb}ุ`; }
  function prepareC(){ cIndex=0; updateCPrompt(); }
  document.getElementById('cSpeak').onclick = ()=> speak(cPrompt.textContent);
  const cRec = makeRecognizer(txt => { cInput.value = txt; });
  document.getElementById('cMic').onclick = ()=> cRec ? cRec.start() : alert('ุงููุชุตูุญ ูุง ูุฏุนู ุงูุฅููุงุก ุงูุตูุชู.');
  document.getElementById('cNext').onclick = ()=>{
    const val = cInput.value.trim(); places[cIndex] = val || '';
    cInput.value=''; cIndex++;
    if (cIndex < 2){ updateCPrompt(); }
    else { initCanvas(); showView('view-D', 4); }
  };

  /* ------------------ STEP D (Canvas) ------------------ */
  function initCanvas(){
    const canvas = document.getElementById('canvas');
    canvas.innerHTML = '';
    const words = [verb, ...subjects, ...objects, ...places].filter(Boolean);
    words.forEach(w=>{
      const el = document.createElement('div');
      el.className='word'; el.textContent=w;
      el.style.top = (10+Math.random()*260)+'px';
      el.style.left = (10+Math.random()*620)+'px';
      el.setAttribute('role','button'); el.setAttribute('tabindex','0');
      el.setAttribute('aria-label', `ูููุฉ: ${w}`);
      canvas.appendChild(el);
      makeDraggable(el);
    });
    ['s1-subj','s1-obj','s1-place','s2-subj','s2-obj','s2-place'].forEach(id=>{
      const el = document.getElementById(id);
      el.textContent = el.id.includes('subj') ? 'ูุงุนู' : (el.id.includes('obj') ? 'ููุนูู' : 'ููุงู');
      el.ondragover = e => e.preventDefault();
    });
  }
  function makeDraggable(el){
    el.draggable = true;
    el.ondragstart = e => { e.dataTransfer.setData('text/plain', el.textContent); };
    document.addEventListener('dragover', e => e.preventDefault());
    document.addEventListener('drop', e => {
      const target = e.target;
      if (target.classList.contains('sentence-blank')){
        e.preventDefault();
        target.textContent = e.dataTransfer.getData('text/plain');
      }
    });
  }
  document.getElementById('dNext').onclick = ()=>{
    startGrammar();
    showView('view-E', 5);
  };

  /* ------------------ STEP E (Grammar) ------------------ */
  const grammarItems = [
    `${verb} ุงูุฑุฌู ุงููุทุฉ.`,
    `ุงููุทุฉ ${verb} ุงูุญููุจ.`,
    `ุฃูุง ${verb} ุงูุชูุงุญุฉ ูู ุงููุทุจุฎ.`
  ];
  const grammarAnswers = [];
  let eIndex = 0;
  const eSentence = document.getElementById('eSentence');
  const eBlock = document.getElementById('eCorrectionBlock');
  const eCorrection = document.getElementById('eCorrection');

  function startGrammar(){
    eIndex = 0; eBlock.style.display = 'none'; eCorrection.value='';
    eSentence.textContent = grammarItems[eIndex];
  }
  document.getElementById('eSpeak').onclick = ()=> speak(eSentence.textContent);

  document.getElementById('eYes').onclick = ()=> { grammarAnswers[eIndex] = {sentence: grammarItems[eIndex], answer:'yes'}; nextGrammar(); };
  document.getElementById('eNo').onclick  = ()=> { grammarAnswers[eIndex] = {sentence: grammarItems[eIndex], answer:'no'}; eBlock.style.display='block'; };

  const eYesRec = makeRecognizer(txt => { if (/^\s*ูุนู\s*$/i.test(txt)) document.getElementById('eYes').click(); });
  const eNoRec  = makeRecognizer(txt => { if (/^\s*ูุง\s*$/i.test(txt))  document.getElementById('eNo').click();  });
  document.getElementById('eMicYes').onclick = ()=> eYesRec ? eYesRec.start() : alert('ูุง ูุฏุนู ุงููุชุตูุญ ุงูุฅููุงุก ุงูุตูุชู.');
  document.getElementById('eMicNo').onclick  = ()=> eNoRec  ? eNoRec.start()  : alert('ูุง ูุฏุนู ุงููุชุตูุญ ุงูุฅููุงุก ุงูุตูุชู.');

  const eFixRec = makeRecognizer(txt => { eCorrection.value = txt; });
  document.getElementById('eMicFix').onclick = ()=> eFixRec ? eFixRec.start() : alert('ูุง ูุฏุนู ุงููุชุตูุญ ุงูุฅููุงุก ุงูุตูุชู.');
  document.getElementById('eConfirm').onclick = ()=>{
    grammarAnswers[eIndex].correction = eCorrection.value.trim();
    eBlock.style.display='none'; eCorrection.value='';
    nextGrammar();
  };

  function nextGrammar(){
    eIndex++;
    if (eIndex < 3){
      eSentence.textContent = grammarItems[eIndex];
    } else {
      startSemantics();
      showView('view-F', 6);
    }
  }

  /* ------------------ STEP F (Semantics) ------------------ */
  const semanticItems = [
    `${verb} ุงูุดูุณ ุงูุทุงููุฉ`,
    `${verb} ุงูุทูู ุงูุบุฏุงุก`,
    `${verb} ุงูุณูุงุฑุฉ ุงููููุฉ`
  ];
  const semanticAnswers = [];
  let fIndex = 0;
  const fPrompt = document.getElementById('fPrompt');
  const fInput  = document.getElementById('fInput');

  function startSemantics(){
    fIndex = 0; fInput.value='';
    fPrompt.textContent = semanticItems[fIndex];
  }
  document.getElementById('fSpeak').onclick = ()=> speak(fPrompt.textContent);
  const fRec = makeRecognizer(txt => { fInput.value = txt; });
  document.getElementById('fMic').onclick = ()=> fRec ? fRec.start() : alert('ูุง ูุฏุนู ุงููุชุตูุญ ุงูุฅููุงุก ุงูุตูุชู.');
  document.getElementById('fNext').onclick = ()=>{
    semanticAnswers.push({item: semanticItems[fIndex], response: fInput.value.trim()});
    fInput.value='';
    fIndex++;
    if (fIndex < semanticItems.length){
      fPrompt.textContent = semanticItems[fIndex];
    } else {
      showView('view-Share'); // progress remains 6/6
    }
  };

  /* ------------------ SHARE ------------------ */
  document.getElementById('shareBtn').onclick = async ()=>{
    const payload = { verb, subjects, objects, places, grammar_questions: grammarAnswers, semantic_items: semanticAnswers };
    const res = await fetch('{{ url_for("share") }}', {   <!-- FIXED HERE -->
      method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    const data = await res.json();
    const div = document.getElementById('shareResult');
    if (data.ok){
      div.innerHTML = `
        <p>ุชู ุฅูุดุงุก ุฑุงุจุท ุงููุดุงุฑูุฉ:</p>
        <input value="${data.url}" id="shareLink" style="width:100%" aria-label="ุฑุงุจุท ุงููุดุงุฑูุฉ">
        <button class="icon small" onclick="navigator.clipboard.writeText(document.getElementById('shareLink').value)">๐ ูุณุฎ ุงูุฑุงุจุท</button>
      `;
      div.style.display = 'block';
    } else {
      div.textContent = 'ุชุนุฐุฑ ุฅูุดุงุก ุงูุฑุงุจุท'; div.style.display = 'block';
    }
  };
</script>
</body>
</html>
